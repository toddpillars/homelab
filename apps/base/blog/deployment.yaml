apiVersion: apps/v1
kind: Deployment
metadata:
  name: blog
  namespace: blog
spec:
  replicas: 1
  selector:
    matchLabels:
      app: blog
  template:
    metadata:
      labels:
        app: blog
    spec:
      containers:
        # Nginx serves the static content
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
              name: http
          volumeMounts:
            - name: html
              mountPath: /usr/share/nginx/html
              readOnly: true
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"

        # git-sync keeps content updated
        - name: git-sync
          image: registry.k8s.io/git-sync/git-sync:v4.3.0
          env:
            - name: GITSYNC_REPO
              value: "git@github.com:toddpillars/blog.git"
            - name: GITSYNC_BRANCH
              value: "main"
            - name: GITSYNC_ROOT
              value: "/tmp/git"
            - name: GITSYNC_DEST
              value: "repo"
            - name: GITSYNC_PERIOD
              value: "60s"  # Check for updates every 60 seconds
            - name: GITSYNC_SSH_KEY_FILE
              value: "/etc/git-secret/ssh"
            - name: GITSYNC_SSH_KNOWN_HOSTS
              value: "false"  # Change from "true" to "false"
            - name: GIT_SSH_COMMAND
              value: "ssh -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=/dev/null"
            - name: GITSYNC_LINK
              value: "current"
            - name: GITSYNC_VERBOSE
              value: "6"
          volumeMounts:
            - name: html
              mountPath: /usr/share/nginx/html
              subPath: current/public  # Hugo builds to public/ folder
              readOnly: true
            - name: git-secret
              mountPath: /etc/git-secret
              readOnly: true
          securityContext:
            runAsUser: 65533  # git-sync user
            runAsGroup: 65533
          resources:
            requests:
              memory: "32Mi"
              cpu: "25m"
            limits:
              memory: "64Mi"
              cpu: "50m"

      volumes:
        - name: html
          emptyDir: {}
        - name: git-secret
          secret:
            secretName: git-ssh-key
            defaultMode: 0400
