apiVersion: apps/v1
kind: Deployment
metadata:
  name: blog
  namespace: blog
spec:
  replicas: 1
  selector:
    matchLabels:
      app: blog
  template:
    metadata:
      labels:
        app: blog
    spec:
      securityContext:
        fsGroup: 65533
      containers:
        # Nginx serves the static content
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
              name: http
          volumeMounts:
            - name: html
              mountPath: /tmp/git
              readOnly: true
          command: ["/bin/sh", "-c"]
          args:
            - |
              cat > /etc/nginx/conf.d/default.conf <<'EOF'
              server {
                  listen 80;
                  root /tmp/git/current/public;
                  index index.html index.xml;
                  location / {
                      try_files $uri $uri/ =404;
                  }
              }
              EOF

              echo "Waiting for git-sync to populate files..."
              until [ -f /tmp/git/current/public/index.html ] || [ -f /tmp/git/current/public/index.xml ]; do
                sleep 2
              done
              echo "Files detected, starting nginx"

              exec nginx -g "daemon off;"
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"

        # git-sync keeps content updated
        - name: git-sync
          image: registry.k8s.io/git-sync/git-sync:v4.6.0
          env:
            - name: GITSYNC_REPO
              value: "git@github.com:toddpillars/blog.git"
            - name: GITSYNC_BRANCH
              value: "main"
            - name: GITSYNC_ROOT
              value: "/tmp/git"
            - name: GITSYNC_DEST
              value: "repo"
            - name: GITSYNC_PERIOD
              value: "60s"
            - name: GITSYNC_SSH_KEY_FILE
              value: "/etc/git-secret/ssh"
            - name: GITSYNC_SSH_KNOWN_HOSTS
              value: "false"
            - name: GIT_SSH_COMMAND
              value: "ssh -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=/dev/null"
            - name: GITSYNC_LINK
              value: "current"
          volumeMounts:
            - name: html
              mountPath: /tmp/git    # Changed from /usr/share/nginx/html
              # Removed subPath completely
            - name: git-secret
              mountPath: /etc/git-secret
              readOnly: true
          securityContext:
            runAsUser: 65533
            runAsGroup: 65533
          resources:
            requests:
              memory: "32Mi"
              cpu: "25m"
            limits:
              memory: "64Mi"
              cpu: "50m"
              
      volumes:
        - name: html
          emptyDir: {}
        - name: git-secret
          secret:
            secretName: git-ssh-key
            defaultMode: 0400
